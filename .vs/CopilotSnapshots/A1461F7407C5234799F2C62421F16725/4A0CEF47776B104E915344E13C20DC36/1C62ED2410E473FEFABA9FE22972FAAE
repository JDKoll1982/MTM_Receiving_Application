# Fix LEAVE statement issues in all stored procedures
# Adds procedure name as label to BEGIN statements when LEAVE is used

$ErrorActionPreference = "Stop"

Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host "  Fix LEAVE Statements in Stored Procedures" -ForegroundColor White
Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host ""

# Get all SQL files in StoredProcedures directory
$sqlFiles = Get-ChildItem -Path "Database\StoredProcedures" -Recurse -Filter "*.sql"

$fixedCount = 0
$checkedCount = 0

foreach ($file in $sqlFiles) {
    $checkedCount++
    $content = Get-Content $file.FullName -Raw
    
    # Check if file contains LEAVE statement
    if ($content -match "LEAVE\s+(\w+)") {
        $procedureName = $matches[1]
        Write-Host "Processing: $($file.FullName)" -ForegroundColor Yellow
        
        # Pattern to match: BEGIN (without label) followed by content with LEAVE
        # We need to add label before BEGIN
        if ($content -match "(?<!$procedureName:\s*)BEGIN\s") {
            # Replace first occurrence of standalone BEGIN with labeled BEGIN
            $newContent = $content -replace "(CREATE PROCEDURE\s+`$procedureName`[^)]+\))\s*BEGIN", "`$1`n$procedureName`: BEGIN"
            
            if ($newContent -ne $content) {
                Set-Content -Path $file.FullName -Value $newContent -NoNewline
                Write-Host "  ✓ Fixed: Added label '$procedureName:' to BEGIN" -ForegroundColor Green
                $fixedCount++
            }
            else {
                Write-Host "  ⚠ Skipped: Pattern not matched (may already be fixed)" -ForegroundColor Gray
            }
        }
        else {
            Write-Host "  ✓ Already fixed: Label present" -ForegroundColor Green
        }
    }
}

Write-Host ""
Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host "Summary:" -ForegroundColor White
Write-Host "  Files checked: $checkedCount" -ForegroundColor White
Write-Host "  Files fixed: $fixedCount" -ForegroundColor Green
Write-Host "================================================================================" -ForegroundColor Cyan
