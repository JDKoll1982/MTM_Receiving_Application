# Database Deployment Script for MTM Receiving Application
# This script deploys all schemas, stored procedures, and initial data

param(
    [string]$Server = "localhost",
    [string]$Port = "3306",
    [string]$Database = "mtm_receiving_application",
    [string]$User = "root",
    [string]$Password = "root"
)

$ErrorActionPreference = "Stop"

# Connection string
$ConnectionString = "Server=$Server;Port=$Port;Database=$Database;Uid=$User;Pwd=$Password;"

Write-Host "=" * 80
Write-Host "MTM Receiving Application - Database Deployment"
Write-Host "=" * 80
Write-Host ""
Write-Host "Connection: $Server`:$Port"
Write-Host "Database: $Database"
Write-Host ""

# Function to execute SQL file using MAMP MySQL
function Execute-SqlFile {
    param(
        [string]$FilePath,
        [string]$Description
    )
    
    Write-Host "Executing: $Description" -ForegroundColor Cyan
    Write-Host "File: $FilePath"
    
    if (-not (Test-Path $FilePath)) {
        Write-Host "  ERROR: File not found!" -ForegroundColor Red
        return $false
    }
    
    try {
        # Try common MAMP MySQL paths
        $mampPaths = @(
            "C:\MAMP\bin\mysql\bin\mysql.exe",
            "C:\MAMP\bin\mysql\mysql8\bin\mysql.exe",
            "mysql"  # Fallback to PATH
        )
        
        $mysqlCmd = $null
        foreach ($path in $mampPaths) {
            if (Test-Path $path -ErrorAction SilentlyContinue) {
                $mysqlCmd = $path
                break
            }
            if ($path -eq "mysql") {
                try {
                    $null = Get-Command mysql -ErrorAction Stop
                    $mysqlCmd = "mysql"
                    break
                }
                catch { }
            }
        }
        
        if (-not $mysqlCmd) {
            Write-Host "  ERROR: MySQL command not found. Please check MAMP installation." -ForegroundColor Red
            Write-Host "  Tried paths: $($mampPaths -join ', ')" -ForegroundColor Yellow
            return $false
        }
        
        # Execute using mysql command with source
        # Note: SQL Server stored procedures (Infor Visual) are not deployed to MySQL
        # We only deploy MySQL-compatible scripts here

        $arguments = "-h$Server -P$Port -u$User -p$Password $Database -e `"source $FilePath`""
        
        $psi = New-Object System.Diagnostics.ProcessStartInfo
        $psi.FileName = $mysqlCmd
        $psi.Arguments = $arguments
        $psi.RedirectStandardOutput = $true
        $psi.RedirectStandardError = $true
        $psi.UseShellExecute = $false
        $psi.CreateNoWindow = $true
        
        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $psi
        $process.Start() | Out-Null
        
        $stdout = $process.StandardOutput.ReadToEnd()
        $stderr = $process.StandardError.ReadToEnd()
        $process.WaitForExit()
        
        if ($process.ExitCode -eq 0) {
            Write-Host "  SUCCESS" -ForegroundColor Green
            if ($stdout) { Write-Host "  Output: $stdout" -ForegroundColor Gray }
            Write-Host ""
            return $true
        }
        else {
            Write-Host "  ERROR: MySQL returned exit code $($process.ExitCode)" -ForegroundColor Red
            if ($stderr) { Write-Host "  Error: $stderr" -ForegroundColor Red }
            Write-Host ""
            return $false
        }
    }
    catch {
        Write-Host "  ERROR: $($_.Exception.Message)" -ForegroundColor Red
        Write-Host ""
        return $false
    }
}

# Get project root (Database folder is at project root)
$ProjectRoot = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
$DatabaseRoot = Join-Path $ProjectRoot "Database"

# Directories to exclude from deployment
$ExcludedDirectories = @(
    "InforVisualScripts",
    "InforVisualTest",
    "Deploy"
)

Write-Host "Scanning for SQL files in: $DatabaseRoot" -ForegroundColor Yellow
Write-Host "Excluding directories: $($ExcludedDirectories -join ', ')" -ForegroundColor Yellow
Write-Host ""

# Step 1: Deploy Schema Files (ordered by filename)
Write-Host "STEP 1: Deploying Database Schemas" -ForegroundColor Yellow
Write-Host "-" * 80

$schemasPath = Join-Path $DatabaseRoot "Schemas"
if (Test-Path $schemasPath) {
    $schemaFiles = Get-ChildItem -Path $schemasPath -Filter "*.sql" | Sort-Object Name
    
    foreach ($file in $schemaFiles) {
        $description = "Schema: $($file.Name)"
        if (-not (Execute-SqlFile -FilePath $file.FullName -Description $description)) {
            Write-Host "Schema deployment failed. Stopping." -ForegroundColor Red
            exit 1
        }
    }
    
    Write-Host "Deployed $($schemaFiles.Count) schema file(s)" -ForegroundColor Green
    Write-Host ""
}
else {
    Write-Host "No Schemas directory found. Skipping." -ForegroundColor Yellow
    Write-Host ""
}

# Step 2: Deploy Migration Files (ordered by filename)
Write-Host "STEP 2: Deploying Database Migrations" -ForegroundColor Yellow
Write-Host "-" * 80

$migrationsPath = Join-Path $DatabaseRoot "Migrations"
if (Test-Path $migrationsPath) {
    $migrationFiles = Get-ChildItem -Path $migrationsPath -Filter "*.sql" | Sort-Object Name
    
    $successCount = 0
    foreach ($file in $migrationFiles) {
        $description = "Migration: $($file.Name)"
        if (Execute-SqlFile -FilePath $file.FullName -Description $description) {
            $successCount++
        }
        else {
            Write-Host "Migration failed. Continuing with next migration..." -ForegroundColor Yellow
        }
    }
    
    Write-Host "Deployed $successCount of $($migrationFiles.Count) migration file(s)" -ForegroundColor Green
    Write-Host ""
}
else {
    Write-Host "No Migrations directory found. Skipping." -ForegroundColor Yellow
    Write-Host ""
}

# Step 3: Deploy Stored Procedures from all subdirectories
Write-Host "STEP 3: Deploying Stored Procedures" -ForegroundColor Yellow
Write-Host "-" * 80

$storedProcsPath = Join-Path $DatabaseRoot "StoredProcedures"
if (Test-Path $storedProcsPath) {
    # Get all subdirectories in StoredProcedures
    $spDirs = Get-ChildItem -Path $storedProcsPath -Directory | Sort-Object Name
    
    $totalSpCount = 0
    foreach ($dir in $spDirs) {
        Write-Host "  Processing: $($dir.Name)" -ForegroundColor Cyan
        
        $spFiles = Get-ChildItem -Path $dir.FullName -Filter "*.sql" | Sort-Object Name
        foreach ($file in $spFiles) {
            $description = "SP [$($dir.Name)]: $($file.Name)"
            if (-not (Execute-SqlFile -FilePath $file.FullName -Description $description)) {
                Write-Host "Stored procedure deployment failed. Stopping." -ForegroundColor Red
                exit 1
            }
            $totalSpCount++
        }
    }
    
    Write-Host "Deployed $totalSpCount stored procedure(s) from $($spDirs.Count) module(s)" -ForegroundColor Green
    Write-Host ""
}
else {
    Write-Host "No StoredProcedures directory found. Skipping." -ForegroundColor Yellow
    Write-Host ""
}

# Step 4: Deploy Test Data
Write-Host "STEP 4: Deploying Test Data" -ForegroundColor Yellow
Write-Host "-" * 80

$testDataPath = Join-Path $DatabaseRoot "TestData"
if (Test-Path $testDataPath) {
    $testDataFiles = Get-ChildItem -Path $testDataPath -Filter "*.sql" | Sort-Object Name
    
    $successCount = 0
    foreach ($file in $testDataFiles) {
        $description = "TestData: $($file.Name)"
        if (Execute-SqlFile -FilePath $file.FullName -Description $description) {
            $successCount++
        }
        else {
            Write-Host "Test data deployment failed. Continuing..." -ForegroundColor Yellow
        }
    }
    
    Write-Host "Deployed $successCount of $($testDataFiles.Count) test data file(s)" -ForegroundColor Green
    Write-Host ""
}
else {
    Write-Host "No TestData directory found. Skipping." -ForegroundColor Yellow
    Write-Host ""
}

Write-Host "=" * 80
Write-Host "Database Deployment Complete!" -ForegroundColor Green
Write-Host "=" * 80
Write-Host ""
Write-Host "Summary:" -ForegroundColor Cyan
Write-Host "  - Deployed schemas from: Schemas\"
Write-Host "  - Deployed migrations from: Migrations\"
Write-Host "  - Deployed stored procedures from: StoredProcedures\*"
Write-Host "  - Deployed test data from: TestData\"
Write-Host "  - Excluded: $($ExcludedDirectories -join ', ')"
Write-Host ""
Write-Host "Next steps:" -ForegroundColor Yellow
Write-Host "1. Verify tables exist in your database"
Write-Host "2. Check that all stored procedures are created"
Write-Host "3. Run the application"
Write-Host ""
