-- Reporting Module Views
-- Purpose: Create views for end-of-day reporting across all modules
-- Date: 2026-01-04
-- Feature: 003-reporting-module

-- View 1: Receiving History
-- Purpose: Flattened view of receiving loads for reporting
-- Source Table: receiving_loads
CREATE OR REPLACE VIEW vw_receiving_history AS
SELECT 
    LoadID AS id,
    PONumber AS po_number,
    PartID AS part_number,
    PartType AS part_description,
    WeightQuantity AS quantity,
    WeightPerPackage AS weight_lbs,
    HeatLotNumber AS heat_lot_number,
    DATE(ReceivedDate) AS created_date,
    NULL AS employee_number,  -- Not tracked in receiving_loads
    'Receiving' AS source_module
FROM receiving_loads
ORDER BY ReceivedDate DESC, LoadID DESC;

-- View 2: Dunnage History
-- Purpose: Flattened view of dunnage loads for reporting
-- Source Tables: dunnage_loads, dunnage_types, dunnage_parts, dunnage_specs
-- Note: Combines load data with type information and concatenated specs
CREATE OR REPLACE VIEW vw_dunnage_history AS
SELECT 
    dl.load_uuid AS id,
    dt.type_name AS dunnage_type,
    dp.part_id AS part_number,
    GROUP_CONCAT(
        CONCAT(ds.spec_key, ':', COALESCE(JSON_UNQUOTE(ds.spec_value), '')) 
        ORDER BY ds.spec_key 
        SEPARATOR ', '
    ) AS specs_combined,
    dl.quantity,
    DATE(dl.received_date) AS created_date,
    dl.created_by AS employee_number,
    'Dunnage' AS source_module
FROM dunnage_loads dl
INNER JOIN dunnage_parts dp ON dl.part_id = dp.part_id
INNER JOIN dunnage_types dt ON dp.type_id = dt.id
LEFT JOIN dunnage_specs ds ON dp.type_id = ds.type_id
GROUP BY dl.load_uuid, dt.type_name, dp.part_id, dl.quantity, dl.received_date, dl.created_by
ORDER BY dl.received_date DESC;

-- View 3: Routing History
-- Purpose: Flattened view of routing labels for reporting
-- Source Table: routing_labels
-- Schema: id, po_number, line_number, description, recipient_id, quantity, created_by, created_date, other_reason_id, is_active, csv_exported, csv_export_date
-- Note: Joins with routing_recipients to get recipient name and location
CREATE OR REPLACE VIEW vw_routing_history AS
SELECT 
    rl.id,
    rl.po_number,
    rl.line_number,
    rl.description AS package_description,
    rr.name AS deliver_to,
    rr.department,
    rr.location,
    rl.quantity,
    rl.created_by AS employee_number,
    rl.created_date,
    CASE 
        WHEN rl.other_reason_id IS NOT NULL THEN ror.description 
        ELSE NULL 
    END AS other_reason,
    'Routing' AS source_module
FROM routing_labels rl
INNER JOIN routing_recipients rr ON rl.recipient_id = rr.id
LEFT JOIN routing_other_reasons ror ON rl.other_reason_id = ror.id
WHERE rl.is_active = 1
ORDER BY rl.created_date DESC, rl.id DESC;

-- View 4: Volvo History
-- Purpose: Flattened view of Volvo shipments for reporting
-- Source Tables: volvo_shipments, volvo_shipment_lines
-- Schema: id, shipment_date, shipment_number, po_number, receiver_number, employee_number, notes, status, created_date, modified_date, is_archived
CREATE OR REPLACE VIEW vw_volvo_history AS
SELECT 
    vs.id,
    vs.shipment_number,
    vs.shipment_date,
    vs.po_number,
    vs.receiver_number,
    vs.status,
    vs.employee_number,
    vs.notes,
    COUNT(vsl.id) AS part_count,
    vs.created_date,
    'Volvo' AS source_module
FROM volvo_shipments vs
LEFT JOIN volvo_shipment_lines vsl ON vs.id = vsl.shipment_id
GROUP BY vs.id, vs.shipment_number, vs.shipment_date, vs.po_number, vs.receiver_number, vs.status, vs.employee_number, vs.notes, vs.created_date
ORDER BY vs.created_date DESC;
