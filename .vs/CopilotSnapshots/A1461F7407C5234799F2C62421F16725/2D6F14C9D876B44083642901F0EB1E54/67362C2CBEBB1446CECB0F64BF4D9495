-- Reporting Module Views
-- Purpose: Create views for end-of-day reporting across all modules
-- Date: 2026-01-04
-- Feature: 003-reporting-module

-- View 1: Receiving History
-- Purpose: Flattened view of receiving loads for reporting
-- Source Table: receiving_loads
CREATE OR REPLACE VIEW vw_receiving_history AS
SELECT 
    LoadID AS id,
    PONumber AS po_number,
    PartID AS part_number,
    PartType AS part_description,
    WeightQuantity AS quantity,
    WeightPerPackage AS weight_lbs,
    HeatLotNumber AS heat_lot_number,
    DATE(ReceivedDate) AS created_date,
    NULL AS employee_number,  -- Not tracked in receiving_loads
    'Receiving' AS source_module
FROM receiving_loads
ORDER BY ReceivedDate DESC, LoadID DESC;

-- View 2: Dunnage History
-- Purpose: Flattened view of dunnage loads for reporting
-- Source Tables: dunnage_loads, dunnage_types, dunnage_parts, dunnage_specs
-- Note: Combines load data with type information and concatenated specs
CREATE OR REPLACE VIEW vw_dunnage_history AS
SELECT 
    dl.load_uuid AS id,
    dt.type_name AS dunnage_type,
    dp.part_id AS part_number,
    GROUP_CONCAT(
        CONCAT(ds.spec_key, ':', COALESCE(JSON_UNQUOTE(ds.spec_value), '')) 
        ORDER BY ds.spec_key 
        SEPARATOR ', '
    ) AS specs_combined,
    dl.quantity,
    DATE(dl.received_date) AS created_date,
    dl.created_by AS employee_number,
    'Dunnage' AS source_module
FROM dunnage_loads dl
INNER JOIN dunnage_parts dp ON dl.part_id = dp.part_id
INNER JOIN dunnage_types dt ON dp.type_id = dt.id
LEFT JOIN dunnage_specs ds ON dp.type_id = ds.type_id
GROUP BY dl.load_uuid, dt.type_name, dp.part_id, dl.quantity, dl.received_date, dl.created_by
ORDER BY dl.received_date DESC;

-- View 3: Routing History
-- Purpose: Flattened view of routing labels for reporting
-- Source Table: routing_labels
-- Note: Filters for archived (completed) routing labels only
CREATE OR REPLACE VIEW vw_routing_history AS
SELECT 
    id,
    label_number,
    deliver_to,
    department,
    package_description,
    po_number,
    work_order AS work_order_number,
    employee_number,
    created_date,
    created_at,
    'Routing' AS source_module
FROM routing_labels
WHERE is_archived = 1
ORDER BY created_date DESC, label_number ASC;

-- View 4: Volvo History (placeholder - table does not exist yet)
-- Purpose: Flattened view of Volvo shipments for reporting
-- Note: Empty placeholder view until Volvo module is implemented
CREATE OR REPLACE VIEW vw_volvo_history AS
SELECT 
    NULL AS id,
    NULL AS shipment_number,
    NULL AS po_number,
    NULL AS receiver_number,
    NULL AS status,
    NULL AS created_date,
    NULL AS part_count,
    NULL AS employee_number,
    'Volvo' AS source_module
FROM dual
WHERE 1=0;  -- Empty view - placeholder until Volvo module is implemented
