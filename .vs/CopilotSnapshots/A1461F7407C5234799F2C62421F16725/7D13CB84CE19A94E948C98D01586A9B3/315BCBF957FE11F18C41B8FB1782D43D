# Fix LEAVE statement issues in all stored procedures
# Adds procedure name as label to BEGIN statements when LEAVE is used

$ErrorActionPreference = "Stop"

Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host "  Fix LEAVE Statements in Stored Procedures" -ForegroundColor White
Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host ""

# Get all SQL files in StoredProcedures directory
$sqlFiles = Get-ChildItem -Path "Database\StoredProcedures" -Recurse -Filter "*.sql"

$fixedCount = 0
$checkedCount = 0

foreach ($file in $sqlFiles) {
    $checkedCount++
    $content = Get-Content $file.FullName -Raw
    
    # Check if file contains LEAVE statement
    if ($content -match 'LEAVE\s+(\w+)') {
        $procedureName = $Matches[1]
        Write-Host "Processing: $($file.Name) - Found LEAVE $procedureName" -ForegroundColor Yellow
        
        # Check if BEGIN already has the label
        $labelCheck = $procedureName + ':\s*BEGIN'
        if ($content -notmatch $labelCheck) {
            # Simple approach: look for )BEGIN and replace with )procedureName: BEGIN
            $searchPattern = '\)\s*BEGIN'
            $replacePattern = ")`n$procedureName`: BEGIN"
            
            if ($content -match $searchPattern) {
                $newContent = $content -replace $searchPattern, $replacePattern, 1
                
                Set-Content -Path $file.FullName -Value $newContent -NoNewline
                Write-Host "  ✓ Fixed: Added label '$procedureName`:' to BEGIN" -ForegroundColor Green
                $fixedCount++
            }
            else {
                Write-Host "  ⚠ Could not find BEGIN statement to fix" -ForegroundColor Yellow
            }
        }
        else {
            Write-Host "  ✓ Already fixed: Label already present" -ForegroundColor Green
        }
    }
}

Write-Host ""
Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host "Summary:" -ForegroundColor White
Write-Host "  Files checked: $checkedCount" -ForegroundColor White
Write-Host "  Files fixed: $fixedCount" -ForegroundColor Green
Write-Host "================================================================================" -ForegroundColor Cyan
