# Database Deployment Script for MTM Receiving Application - GUI Version
# This script deploys all schemas, stored procedures, and initial data using a WPF GUI

param(
    [string]$Server = "localhost",
    [string]$Port = "3306",
    [string]$Database = "mtm_receiving_application",
    [string]$User = "root",
    [string]$Password = "root"
)

Add-Type -AssemblyName PresentationFramework
Add-Type -AssemblyName PresentationCore
Add-Type -AssemblyName WindowsBase

# XAML for the deployment window
$xaml = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="MTM Database Deployment" 
        Height="600" Width="800"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize"
        Background="#F5F5F5">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="MTM Receiving Application" 
                       FontSize="24" 
                       FontWeight="Bold" 
                       Foreground="#2196F3"/>
            <TextBlock Text="Database Deployment Tool" 
                       FontSize="16" 
                       Foreground="#666"/>
        </StackPanel>

        <!-- Connection Details -->
        <Border Grid.Row="1" 
                Background="White" 
                BorderBrush="#DDD" 
                BorderThickness="1" 
                CornerRadius="5" 
                Padding="15" 
                Margin="0,0,0,20">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Grid.Column="0" Text="Server:" FontWeight="Bold" Margin="0,5"/>
                <TextBlock Grid.Row="0" Grid.Column="1" Name="ServerText" Margin="10,5" Foreground="#333"/>

                <TextBlock Grid.Row="1" Grid.Column="0" Text="Database:" FontWeight="Bold" Margin="0,5"/>
                <TextBlock Grid.Row="1" Grid.Column="1" Name="DatabaseText" Margin="10,5" Foreground="#333"/>

                <TextBlock Grid.Row="2" Grid.Column="0" Text="User:" FontWeight="Bold" Margin="0,5"/>
                <TextBlock Grid.Row="2" Grid.Column="1" Name="UserText" Margin="10,5" Foreground="#333"/>
            </Grid>
        </Border>

        <!-- Progress Section -->
        <Border Grid.Row="2" 
                Background="White" 
                BorderBrush="#DDD" 
                BorderThickness="1" 
                CornerRadius="5" 
                Padding="15">
            <StackPanel>
                <!-- Overall Progress -->
                <TextBlock Name="OverallStatusText" 
                           Text="Ready to deploy..." 
                           FontSize="14" 
                           FontWeight="Bold" 
                           Margin="0,0,0,10"/>

                <!-- Step 1: Schemas -->
                <StackPanel Name="SchemaSection" Margin="0,5">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Name="SchemaText" Text="[1/4] Database Schemas" Foreground="#666"/>
                        <TextBlock Grid.Column="1" Name="SchemaCount" Text="0/0" Foreground="#2196F3"/>
                    </Grid>
                    <ProgressBar Name="SchemaProgress" Height="8" Margin="0,5" Maximum="100"/>
                </StackPanel>

                <!-- Step 2: Migrations -->
                <StackPanel Name="MigrationSection" Margin="0,5">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Name="MigrationText" Text="[2/4] Database Migrations" Foreground="#666"/>
                        <TextBlock Grid.Column="1" Name="MigrationCount" Text="0/0" Foreground="#2196F3"/>
                    </Grid>
                    <ProgressBar Name="MigrationProgress" Height="8" Margin="0,5" Maximum="100"/>
                </StackPanel>

                <!-- Step 3: Stored Procedures -->
                <StackPanel Name="StoredProcSection" Margin="0,5">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Name="StoredProcText" Text="[3/4] Stored Procedures" Foreground="#666"/>
                        <TextBlock Grid.Column="1" Name="StoredProcCount" Text="0/0" Foreground="#2196F3"/>
                    </Grid>
                    <ProgressBar Name="StoredProcProgress" Height="8" Margin="0,5" Maximum="100"/>
                </StackPanel>

                <!-- Step 4: Test Data -->
                <StackPanel Name="TestDataSection" Margin="0,5">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Name="TestDataText" Text="[4/4] Test Data" Foreground="#666"/>
                        <TextBlock Grid.Column="1" Name="TestDataCount" Text="0/0" Foreground="#2196F3"/>
                    </Grid>
                    <ProgressBar Name="TestDataProgress" Height="8" Margin="0,5" Maximum="100"/>
                </StackPanel>

                <!-- Current File -->
                <TextBlock Name="CurrentFileText" 
                           Text="" 
                           Margin="0,15,0,0" 
                           FontSize="11" 
                           Foreground="#999" 
                           TextTrimming="CharacterEllipsis"/>

                <!-- Error Display -->
                <Border Name="ErrorBorder" 
                        Background="#FFEBEE" 
                        BorderBrush="#F44336" 
                        BorderThickness="1" 
                        CornerRadius="3" 
                        Padding="10" 
                        Margin="0,10,0,0"
                        Visibility="Collapsed">
                    <TextBlock Name="ErrorText" 
                               Foreground="#C62828" 
                               TextWrapping="Wrap"/>
                </Border>
            </StackPanel>
        </Border>

        <!-- Summary Section -->
        <Border Grid.Row="3" 
                Name="SummaryBorder"
                Background="#E8F5E9" 
                BorderBrush="#4CAF50" 
                BorderThickness="1" 
                CornerRadius="5" 
                Padding="15" 
                Margin="0,20,0,0"
                Visibility="Collapsed">
            <StackPanel>
                <TextBlock Text="✓ Deployment Successful!" 
                           FontSize="16" 
                           FontWeight="Bold" 
                           Foreground="#2E7D32" 
                           Margin="0,0,0,10"/>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Schemas Deployed:" Margin="0,2"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" Name="SummarySchemas" Margin="10,2" FontWeight="Bold"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Migrations Applied:" Margin="0,2"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Name="SummaryMigrations" Margin="10,2" FontWeight="Bold"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Stored Procedures:" Margin="0,2"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Name="SummaryStoredProcs" Margin="10,2" FontWeight="Bold"/>

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Test Data Files:" Margin="0,2"/>
                    <TextBlock Grid.Row="3" Grid.Column="1" Name="SummaryTestData" Margin="10,2" FontWeight="Bold"/>
                </Grid>
            </StackPanel>
        </Border>

        <!-- Buttons -->
        <StackPanel Grid.Row="4" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Right" 
                    Margin="0,20,0,0">
            <Button Name="DeployButton" 
                    Content="Start Deployment" 
                    Width="140" 
                    Height="35" 
                    Background="#2196F3" 
                    Foreground="White" 
                    BorderThickness="0" 
                    FontWeight="Bold"
                    Cursor="Hand"/>
            <Button Name="CloseButton" 
                    Content="Close" 
                    Width="100" 
                    Height="35" 
                    Margin="10,0,0,0"
                    Background="#9E9E9E" 
                    Foreground="White" 
                    BorderThickness="0"
                    Cursor="Hand"/>
        </StackPanel>
    </Grid>
</Window>
"@

# Load XAML
$reader = [System.Xml.XmlNodeReader]::new([xml]$xaml)
$window = [Windows.Markup.XamlReader]::Load($reader)

# Get controls
$serverText = $window.FindName("ServerText")
$databaseText = $window.FindName("DatabaseText")
$userText = $window.FindName("UserText")
$overallStatusText = $window.FindName("OverallStatusText")
$currentFileText = $window.FindName("CurrentFileText")

$schemaProgress = $window.FindName("SchemaProgress")
$schemaCount = $window.FindName("SchemaCount")
$migrationProgress = $window.FindName("MigrationProgress")
$migrationCount = $window.FindName("MigrationCount")
$storedProcProgress = $window.FindName("StoredProcProgress")
$storedProcCount = $window.FindName("StoredProcCount")
$testDataProgress = $window.FindName("TestDataProgress")
$testDataCount = $window.FindName("TestDataCount")

$errorBorder = $window.FindName("ErrorBorder")
$errorText = $window.FindName("ErrorText")
$summaryBorder = $window.FindName("SummaryBorder")
$summarySchemas = $window.FindName("SummarySchemas")
$summaryMigrations = $window.FindName("SummaryMigrations")
$summaryStoredProcs = $window.FindName("SummaryStoredProcs")
$summaryTestData = $window.FindName("SummaryTestData")

$deployButton = $window.FindName("DeployButton")
$closeButton = $window.FindName("CloseButton")

# Set connection details
$serverText.Text = "$Server`:$Port"
$databaseText.Text = $Database
$userText.Text = $User

# Counters
$script:SchemaCount = 0
$script:MigrationCount = 0
$script:StoredProcCount = 0
$script:TestDataCount = 0

# Function to execute SQL file
function Execute-SqlFile {
    param(
        [string]$FilePath,
        [switch]$DisableForeignKeyChecks
    )
    
    if (-not (Test-Path $FilePath)) {
        return $false
    }
    
    try {
        $mampPaths = @(
            "C:\MAMP\bin\mysql\bin\mysql.exe",
            "C:\MAMP\bin\mysql\mysql8\bin\mysql.exe",
            "mysql"
        )
        
        $mysqlCmd = $null
        foreach ($path in $mampPaths) {
            if (Test-Path $path -ErrorAction SilentlyContinue) {
                $mysqlCmd = $path
                break
            }
            if ($path -eq "mysql") {
                try {
                    $null = Get-Command mysql -ErrorAction Stop
                    $mysqlCmd = "mysql"
                    break
                }
                catch { }
            }
        }
        
        if (-not $mysqlCmd) {
            return $false
        }
        
        $mysqlPath = $FilePath -replace '\\', '/'
        
        $sqlCommand = if ($DisableForeignKeyChecks) {
            "SET FOREIGN_KEY_CHECKS = 0; source $mysqlPath; SET FOREIGN_KEY_CHECKS = 1;"
        } else {
            "source $mysqlPath"
        }
        
        $arguments = "-h$Server -P$Port -u$User -p$Password $Database -e `"$sqlCommand`""
        
        $psi = New-Object System.Diagnostics.ProcessStartInfo
        $psi.FileName = $mysqlCmd
        $psi.Arguments = $arguments
        $psi.RedirectStandardOutput = $true
        $psi.RedirectStandardError = $true
        $psi.UseShellExecute = $false
        $psi.CreateNoWindow = $true
        
        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $psi
        $process.Start() | Out-Null
        
        $stdout = $process.StandardOutput.ReadToEnd()
        $stderr = $process.StandardError.ReadToEnd()
        $process.WaitForExit()
        
        if ($process.ExitCode -eq 0) {
            return $true
        }
        else {
            throw $stderr
        }
    }
    catch {
        throw $_
    }
}

# Deployment function
$deployScript = {
    $ProjectRoot = Split-Path -Parent (Split-Path -Parent $PSScriptRoot)
    $DatabaseRoot = Join-Path $ProjectRoot "Database"
    
    $ExcludedFilePatterns = @("test_*.sql", "*_test.sql", "*.test.sql")
    
    $window.Dispatcher.Invoke([action]{
        $deployButton.IsEnabled = $false
        $overallStatusText.Text = "Deploying database..."
    })
    
    try {
        # Step 1: Schemas
        $schemasPath = Join-Path $DatabaseRoot "Schemas"
        if (Test-Path $schemasPath) {
            $schemaFiles = Get-ChildItem -Path $schemasPath -Filter "*.sql" | 
                Where-Object { 
                    $filename = $_.Name
                    -not ($ExcludedFilePatterns | Where-Object { $filename -like $_ })
                } | Sort-Object Name
            
            $total = $schemaFiles.Count
            $current = 0
            
            foreach ($file in $schemaFiles) {
                $current++
                $percent = [int](($current / $total) * 100)
                
                $window.Dispatcher.Invoke([action]{
                    $schemaProgress.Value = $percent
                    $schemaCount.Text = "$current/$total"
                    $currentFileText.Text = "Deploying: $($file.Name)"
                })
                
                Execute-SqlFile -FilePath $file.FullName -DisableForeignKeyChecks
                $script:SchemaCount++
                Start-Sleep -Milliseconds 100
            }
        }
        
        # Step 2: Migrations
        $migrationsPath = Join-Path $DatabaseRoot "Migrations"
        if (Test-Path $migrationsPath) {
            $migrationFiles = Get-ChildItem -Path $migrationsPath -Filter "*.sql" | 
                Where-Object { 
                    $filename = $_.Name
                    -not ($ExcludedFilePatterns | Where-Object { $filename -like $_ })
                } | Sort-Object Name
            
            $total = $migrationFiles.Count
            $current = 0
            
            foreach ($file in $migrationFiles) {
                $current++
                $percent = [int](($current / $total) * 100)
                
                $window.Dispatcher.Invoke([action]{
                    $migrationProgress.Value = $percent
                    $migrationCount.Text = "$current/$total"
                    $currentFileText.Text = "Deploying: $($file.Name)"
                })
                
                if (Execute-SqlFile -FilePath $file.FullName -DisableForeignKeyChecks) {
                    $script:MigrationCount++
                }
                Start-Sleep -Milliseconds 100
            }
        }
        
        # Step 3: Stored Procedures
        $storedProcsPath = Join-Path $DatabaseRoot "StoredProcedures"
        if (Test-Path $storedProcsPath) {
            $allSpFiles = Get-ChildItem -Path $storedProcsPath -Recurse -Filter "*.sql" | 
                Where-Object { 
                    $filename = $_.Name
                    -not ($ExcludedFilePatterns | Where-Object { $filename -like $_ })
                } | Sort-Object FullName
            
            $total = $allSpFiles.Count
            $current = 0
            
            foreach ($file in $allSpFiles) {
                $current++
                $percent = [int](($current / $total) * 100)
                
                $window.Dispatcher.Invoke([action]{
                    $storedProcProgress.Value = $percent
                    $storedProcCount.Text = "$current/$total"
                    $currentFileText.Text = "Deploying: $($file.Name)"
                })
                
                Execute-SqlFile -FilePath $file.FullName
                $script:StoredProcCount++
                Start-Sleep -Milliseconds 50
            }
        }
        
        # Step 4: Test Data
        $testDataPath = Join-Path $DatabaseRoot "TestData"
        if (Test-Path $testDataPath) {
            $testDataFiles = Get-ChildItem -Path $testDataPath -Filter "*.sql" | 
                Where-Object { 
                    $filename = $_.Name
                    -not ($ExcludedFilePatterns | Where-Object { $filename -like $_ })
                } | Sort-Object Name
            
            $total = $testDataFiles.Count
            $current = 0
            
            foreach ($file in $testDataFiles) {
                $current++
                $percent = [int](($current / $total) * 100)
                
                $window.Dispatcher.Invoke([action]{
                    $testDataProgress.Value = $percent
                    $testDataCount.Text = "$current/$total"
                    $currentFileText.Text = "Deploying: $($file.Name)"
                })
                
                if (Execute-SqlFile -FilePath $file.FullName) {
                    $script:TestDataCount++
                }
                Start-Sleep -Milliseconds 100
            }
        }
        
        # Success!
        $window.Dispatcher.Invoke([action]{
            $overallStatusText.Text = "Deployment completed successfully!"
            $currentFileText.Text = ""
            $summaryBorder.Visibility = "Visible"
            $summarySchemas.Text = "$script:SchemaCount file(s)"
            $summaryMigrations.Text = "$script:MigrationCount file(s)"
            $summaryStoredProcs.Text = "$script:StoredProcCount procedure(s)"
            $summaryTestData.Text = "$script:TestDataCount file(s)"
            $deployButton.Content = "Deploy Again"
            $deployButton.IsEnabled = $true
        })
    }
    catch {
        $window.Dispatcher.Invoke([action]{
            $overallStatusText.Text = "Deployment failed!"
            $errorBorder.Visibility = "Visible"
            $errorText.Text = $_.Exception.Message
            $deployButton.Content = "Retry"
            $deployButton.IsEnabled = $true
        })
    }
}

# Button events
$deployButton.Add_Click({
    $errorBorder.Visibility = "Collapsed"
    $summaryBorder.Visibility = "Collapsed"
    Start-Job -ScriptBlock $deployScript | Out-Null
})

$closeButton.Add_Click({
    $window.Close()
})

# Show window
$window.ShowDialog() | Out-Null
