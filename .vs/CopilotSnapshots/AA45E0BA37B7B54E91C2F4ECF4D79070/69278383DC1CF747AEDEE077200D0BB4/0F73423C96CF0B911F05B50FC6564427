using FluentAssertions;
using Xunit;
using MTM_Receiving_Application.Module_Receiving.Data;
using MTM_Receiving_Application.Module_Receiving.Models;
using MTM_Receiving_Application.Module_Core.Models.Enums;

namespace MTM_Receiving_Application.Tests.Unit.Module_Receiving.Data;

/// <summary>
/// Unit tests for Dao_ReceivingLine data access object.
/// Tests constructor validation and parameter handling without requiring database connection.
/// NOTE: These are UNIT tests, not integration tests. Database operations are tested separately.
/// </summary>
public class Dao_ReceivingLine_Tests
{
    private const string TestConnectionString = "Server=localhost;Database=test_db;User Id=test;Password=test;";

    // ====================================================================
    // Constructor Tests
    // ====================================================================

    [Fact]
    public void Constructor_ValidConnectionString_CreatesInstance()
    {
        // Act
        var dao = new Dao_ReceivingLine(TestConnectionString);

        // Assert
        dao.Should().NotBeNull();
    }

    [Fact]
    public void Constructor_NullConnectionString_ThrowsArgumentNullException()
    {
        // Act
        Action act = () => new Dao_ReceivingLine(null!);

        // Assert
        act.Should().Throw<ArgumentNullException>()
            .WithParameterName("connectionString");
    }

    [Fact]
    public void Constructor_EmptyConnectionString_DoesNotThrow()
    {
        // NOTE: Constructor accepts empty string, but database operations will fail gracefully
        // Act
        Action act = () => new Dao_ReceivingLine(string.Empty);

        // Assert
        act.Should().NotThrow();
    }

    // ====================================================================
    // InsertReceivingLineAsync Tests - Database Connection Failures
    // ====================================================================

    [Fact]
    public async Task InsertReceivingLineAsync_InvalidConnectionString_ReturnsFailureResult()
    {
        // Arrange - Use invalid connection string to simulate connection failure
        var dao = new Dao_ReceivingLine("Server=invalid;Database=nonexistent;");
        var line = CreateValidReceivingLine();

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert - DAO MUST return failure result, NOT throw exception (Constitutional requirement)
        result.Should().NotBeNull();
        result.Success.Should().BeFalse("DAO must return failure result instead of throwing exception");
        result.ErrorMessage.Should().NotBeNullOrEmpty();
        result.Severity.Should().Be(Enum_ErrorSeverity.Error);
    }

    // ====================================================================
    // InsertReceivingLineAsync Tests - Parameter Handling
    // ====================================================================

    [Fact]
    public async Task InsertReceivingLineAsync_NullPartID_ReturnsResult()
    {
        // Arrange - Invalid connection ensures we're testing parameter construction, not DB
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.PartID = null;

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert - DAO handles null PartID by converting to empty string per implementation
        result.Should().NotBeNull();
        // Will fail due to connection, but that's expected - we're testing it doesn't throw
    }

    [Fact]
    public async Task InsertReceivingLineAsync_NullHeat_ReturnsResult()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.Heat = null;

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert - DAO handles null Heat by converting to empty string per implementation
        result.Should().NotBeNull();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_NullInitialLocation_ReturnsResult()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.InitialLocation = null;

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert
        result.Should().NotBeNull();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_NullCoilsOnSkid_ReturnsResult()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.CoilsOnSkid = null;

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert - DAO handles null CoilsOnSkid by converting to DBNull.Value per implementation
        result.Should().NotBeNull();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_NullVendorName_ReturnsResult()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.VendorName = null;

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert - DAO handles null VendorName by using "Unknown" per implementation
        result.Should().NotBeNull();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_NullPartDescription_ReturnsResult()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.PartDescription = null;

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert
        result.Should().NotBeNull();
    }

    // ====================================================================
    // InsertReceivingLineAsync Tests - Value Range Handling
    // ====================================================================

    [Theory]
    [InlineData(1)]
    [InlineData(100)]
    [InlineData(1000)]
    [InlineData(0)]
    [InlineData(-1)]
    public async Task InsertReceivingLineAsync_DifferentQuantities_HandlesAllValues(int quantity)
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.Quantity = quantity;

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert - DAO accepts all quantity values (validation is Service layer responsibility)
        result.Should().NotBeNull();
    }

    [Theory]
    [InlineData(0)]
    [InlineData(12345)]
    [InlineData(67890)]
    [InlineData(999999)]
    [InlineData(-1)]
    public async Task InsertReceivingLineAsync_DifferentPONumbers_HandlesAllValues(int poNumber)
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.PONumber = poNumber;

        // Act
        var result = await dao.InsertReceivingLineAsync(line);

        // Assert
        result.Should().NotBeNull();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_AllFieldsPopulated_DoesNotThrow()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = new Model_ReceivingLine
        {
            Quantity = 500,
            PartID = "PART-12345",
            PONumber = 67890,
            EmployeeNumber = 1001,
            Heat = "HEAT-ABC123",
            Date = DateTime.Now,
            InitialLocation = "A-01-B",
            CoilsOnSkid = 10,
            VendorName = "Acme Corp",
            PartDescription = "Steel Coil 1.5mm x 48in"
        };

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert - DAO must not throw exceptions (Constitutional requirement)
        await act.Should().NotThrowAsync();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_MinimalFields_DoesNotThrow()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = new Model_ReceivingLine
        {
            Quantity = 1,
            PONumber = 1,
            EmployeeNumber = 100,
            Date = DateTime.Now
        };

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert - DAO must not throw exceptions
        await act.Should().NotThrowAsync();
    }

    // ====================================================================
    // Edge Cases and Boundary Value Tests
    // ====================================================================

    [Fact]
    public async Task InsertReceivingLineAsync_VeryLongPartID_DoesNotThrow()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.PartID = new string('A', 500);

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert - DAO passes value to DB, which will enforce length constraints
        await act.Should().NotThrowAsync();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_VeryLongHeat_DoesNotThrow()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.Heat = new string('H', 1000);

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert
        await act.Should().NotThrowAsync();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_VeryLongPartDescription_DoesNotThrow()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.PartDescription = new string('D', 2000);

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert
        await act.Should().NotThrowAsync();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_FutureDate_DoesNotThrow()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.Date = DateTime.Now.AddYears(1);

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert - Date validation is business logic, DAO just passes it through
        await act.Should().NotThrowAsync();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_PastDate_DoesNotThrow()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.Date = DateTime.Now.AddYears(-10);

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert
        await act.Should().NotThrowAsync();
    }

    [Theory]
    [InlineData(int.MinValue)]
    [InlineData(-1)]
    [InlineData(0)]
    [InlineData(1)]
    [InlineData(int.MaxValue)]
    public async Task InsertReceivingLineAsync_BoundaryCoilsOnSkid_DoesNotThrow(int? coilsOnSkid)
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.CoilsOnSkid = coilsOnSkid;

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert
        await act.Should().NotThrowAsync();
    }

    [Theory]
    [InlineData(int.MinValue)]
    [InlineData(-1000)]
    [InlineData(0)]
    [InlineData(1)]
    [InlineData(99999)]
    [InlineData(int.MaxValue)]
    public async Task InsertReceivingLineAsync_BoundaryEmployeeNumbers_DoesNotThrow(int employeeNumber)
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.EmployeeNumber = employeeNumber;

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert
        await act.Should().NotThrowAsync();
    }

    [Fact]
    public async Task InsertReceivingLineAsync_SpecialCharactersInFields_DoesNotThrow()
    {
        // Arrange
        var dao = new Dao_ReceivingLine("Server=invalid;");
        var line = CreateValidReceivingLine();
        line.PartID = "PART-@#$%^&*()";
        line.Heat = "HEAT-<>{}[]";
        line.VendorName = "Vendor's \"Company\"";

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert - DAO should pass special characters safely (parameterized queries prevent SQL injection)
        await act.Should().NotThrowAsync();
    }

    // ====================================================================
    // Constitutional Compliance Tests
    // ====================================================================

    [Fact]
    public async Task InsertReceivingLineAsync_DatabaseException_ReturnsFailureNotThrow()
    {
        // Arrange - Empty connection string will cause connection failure
        var dao = new Dao_ReceivingLine(string.Empty);
        var line = CreateValidReceivingLine();

        // Act
        Func<Task> act = async () => await dao.InsertReceivingLineAsync(line);

        // Assert - CRITICAL: DAO MUST NOT throw exceptions per Constitutional Rule II
        await act.Should().NotThrowAsync("DAO must return failure result instead of throwing exception");
        
        var result = await dao.InsertReceivingLineAsync(line);
        result.Success.Should().BeFalse();
        result.ErrorMessage.Should().NotBeNullOrEmpty();
    }

    // ====================================================================
    // Helper Methods
    // ====================================================================

    /// <summary>
    /// Creates a valid test receiving line with all required fields populated.
    /// </summary>
    private static Model_ReceivingLine CreateValidReceivingLine()
    {
        return new Model_ReceivingLine
        {
            Quantity = 100,
            PartID = "PART-001",
            PONumber = 12345,
            EmployeeNumber = 1001,
            Heat = "HEAT-123",
            Date = DateTime.Now,
            InitialLocation = "A-01",
            CoilsOnSkid = 5,
            VendorName = "Test Vendor",
            PartDescription = "Test Part Description"
        };
    }
}
