# Stored Procedure Testing Suite

Automated testing framework for all MySQL stored procedures in the MTM Receiving Application database.

## Overview

This directory contains PowerShell scripts that automatically test all stored procedures by:

1. Analyzing SP signatures and generating intelligent mock data
2. Executing each SP with mock parameters
3. Categorizing failures (schema errors, constraints, validation, etc.)
4. Generating comprehensive reports

## Files

### Scripts

| File | Description |
|------|-------------|
| `01-Generate-SP-TestData.ps1` | Analyzes all SPs and generates mock data + execution order |
| `02-Test-StoredProcedures.ps1` | Executes all SPs and generates test report |
| `03-Analyze-SP-Usage.ps1` | Analyzes SP usage in codebase and hardcoded SQL queries |

### Generated Files

| File | Description | Generated By |
|------|-------------|--------------|
| `sp-mock-data.json` | Mock parameter values for each SP | Script 01 |
| `01-order.json` | Dependency-aware execution order | Script 01 |
| `01-report.md` | SP analysis report (categories, parameters, complexity) | Script 01 |
| `02-report.md` | Test execution results with error categorization | Script 02 |
| `03-usage-report.md` | SP usage analysis with links to individual reports | Script 03 |
| `03-hardcode-report.md` | Hardcoded SQL queries categorized by database type | Script 03 |
| `sp-reports/` | Individual detailed reports for each SP | Script 03 |

## Quick Start

### 1. Generate Mock Data (First Time Setup)

```powershell
# From project root
cd Database\00-Test
pwsh -File .\01-Generate-SP-TestData.ps1
```

**Output:**

- `01-mock-data.json` - Parameter values for testing
- `01-order.json` - Execution groups to avoid FK errors
- `01-report.md` - Analysis of all 153 stored procedures

### 2. Run Tests

```powershell
# Run in alphabetical order (faster, more FK errors)
pwsh -File .\02-Test-StoredProcedures.ps1

# Run in dependency order (slower, fewer FK errors) - RECOMMENDED
pwsh -File .\02-Test-StoredProcedures.ps1 -UseExecutionOrder
```

**Output:**

- `02-report.md` - Comprehensive test results with categorized failures

## Usage

### Initial Setup Workflow

```powershell
# 1. Build project to get MySql.Data.dll
cd ..\..  # Go to project root
dotnet build

# 2. Generate test configuration
cd Database\00-Test
pwsh -File .\01-Generate-SP-TestData.ps1

# 3. Review generated mock data (optional)
code 01-mock-data.json

# 4. Run tests
pwsh -File .\02-Test-StoredProcedures.ps1 -UseExecutionOrder

# 5. Review results
code 02-report.md
```

### After Adding New Stored Procedures

```powershell
# Regenerate configuration to include new SPs
pwsh -File .\01-Generate-SP-TestData.ps1

# Run tests
pwsh -File .\02-Test-StoredProcedures.ps1 -UseExecutionOrder
```

### After Changing SP Signatures

```powershell
# Regenerate to update parameter counts
pwsh -File .\01-Generate-SP-TestData.ps1

# Test again
pwsh -File .\02-Test-StoredProcedures.ps1 -UseExecutionOrder
```

## Script Parameters

### 01-Generate-SP-TestData.ps1

```powershell
pwsh -File .\01-Generate-SP-TestData.ps1 `
    -Server "localhost" `
    -Port 3306 `
    -Database "mtm_receiving_application" `
    -User "root"
```

### 02-Test-StoredProcedures.ps1

```powershell
pwsh -File .\02-Test-StoredProcedures.ps1 `
    -Server "localhost" `
    -Port 3306 `
    -Database "mtm_receiving_application" `
    -User "root" `
    -UseExecutionOrder  # Optional: Use dependency-aware order
```

## Understanding Reports

### 01-report.md (Analysis Report)

Shows:

- Total SPs analyzed (153)
- Parameter statistics (IN/OUT/INOUT counts)
- SPs organized by category (Users, Dunnage, Routing, etc.)
- Execution order groups (dependency-aware)
- Complex SPs (8+ parameters)

**Use this to:**

- Understand database structure
- Identify complex procedures
- Review execution dependencies

### 02-report.md (Test Report)

Shows:

- Success rate and failure breakdown
- Results by category
- Critical failures (schema errors)
- Parameter mismatches
- Constraint violations
- Data validation errors
- Actionable recommendations

**Use this to:**

- Identify broken stored procedures
- Prioritize fixes (schema > parameters > constraints)
- Track testing progress

## Error Categories

| Category | Description | Severity | Action Required |
|----------|-------------|----------|-----------------|
| **Schema Broken** | References non-existent columns/tables | üî¥ Critical | Fix SP SQL or database schema |
| **Parameter Mismatch** | Wrong number of arguments | ‚ö†Ô∏è High | Regenerate mock data |
| **Constraint Violation** | Foreign key errors | ‚ö†Ô∏è Medium | Use `-UseExecutionOrder` or add test data |
| **Data Validation** | Type mismatch, truncation, duplicates | ‚ö†Ô∏è Medium | Update mock values in 01-mock-data.json |
| **Runtime Error** | Other execution failures | ‚ÑπÔ∏è Low | Investigate individual SPs |
| **Logic Caught** | Intentional SP validation (SQLSTATE 45000) | ‚úÖ Expected | These are normal business logic checks |

## Customizing Mock Data

Edit `01-mock-data.json` to customize test values:

```json
{
  "sp_UpsertUser": {
    "category": "Users",
    "executionOrder": 10,
    "enabled": true,
    "parameters": {
      "p_windows_username": "TEST_USER",
      "p_display_name": "Test User",
      "p_pin": "1234",
      "p_employee_number": 12345
    }
  }
}
```

**Common customizations:**

- Change `p_user_id` to match existing test user
- Update `p_po_number` to reference real test POs
- Set `enabled: false` to skip problematic SPs
- Adjust dates, part numbers, quantities for realistic tests

## Execution Order

Stored procedures are grouped by dependencies to minimize FK constraint errors:

| Order Range | Category | Examples |
|-------------|----------|----------|
| 10-50 | Core/Lookup Tables | Users, Departments, Package Types |
| 60-90 | Reference Data | Dunnage Types/Specs/Parts, Routing Recipients |
| 100-200 | Transactional | Receiving Loads, Dunnage Loads, Routing Labels |
| 200-999 | Settings/Preferences | System Settings, User Preferences |
| 1000+ | Read Operations | All GET/SELECT queries |
| 2000+ | Delete Operations | All DELETE queries |

**Why execution order matters:**

- INSERT operations must run before dependent INSERTs
- Avoids FK constraint failures
- Mimics real-world usage patterns

## Troubleshooting

### "PowerShell 7+ required"

**Solution:**

```powershell
winget install --id Microsoft.PowerShell --source winget
```

### "MySql.Data.dll not found"

**Solution:**

```powershell
# From project root
dotnet build
```

### "MAMP MySQL service not running"

**Solution:**

- Open MAMP application
- Click "Start Servers"
- Verify MySQL is running on port 3306 (or 8889 for MAMP PRO)

### High failure rate

**Solutions:**

1. **Use execution order:**

   ```powershell
   pwsh -File .\02-Test-StoredProcedures.ps1 -UseExecutionOrder
   ```

2. **Regenerate mock data:**

   ```powershell
   pwsh -File .\01-Generate-SP-TestData.ps1
   ```

3. **Add test data:**
   - Create test users, parts, POs in database
   - Update mock values to reference existing IDs

### Parameter count mismatches

**Cause:** SP signature changed but mock data not updated

**Solution:**

```powershell
pwsh -File .\01-Generate-SP-TestData.ps1
```

## Best Practices

### Regular Testing

- Run tests after schema changes
- Run tests after adding new SPs
- Run tests before major deployments

### Mock Data Management

- Keep `01-mock-data.json` in version control
- Document custom test values
- Use realistic but non-production data

### Continuous Integration

```powershell
# CI pipeline example
dotnet build
pwsh -File .\Database\00-Test\01-Generate-SP-TestData.ps1
pwsh -File .\Database\00-Test\02-Test-StoredProcedures.ps1 -UseExecutionOrder
# Check exit code and fail build if critical errors
```

### Prioritizing Fixes

1. **Critical (Schema Broken)** - Fix immediately, blocks all operations
2. **High (Parameter Mismatch)** - Quick fix by regenerating config
3. **Medium (Constraints)** - Use execution order or add test data
4. **Low (Other Runtime)** - Investigate case-by-case

## Advanced Usage

### Testing Specific Categories

Edit `01-order.json` to disable categories:

```json
{
  "executionGroups": [
    {
      "order": 10,
      "category": "Users",
      "storedProcedures": ["sp_user_insert"]  // Remove SPs to skip
    }
  ]
}
```

### Custom Connection String

```powershell
pwsh -File .\02-Test-StoredProcedures.ps1 `
    -Server "192.168.1.100" `
    -Port 3307 `
    -Database "mtm_test" `
    -User "testuser"
```

### Debugging Individual SPs

1. Find SP in `02-report.md`
2. Check error message and category
3. Review mock values in `01-mock-data.json`
4. Test manually:

   ```sql
   CALL sp_name('TEST_VALUE', 123, '2026-01-01');
   ```

## File Maintenance

### Clean Up

```powershell
# Remove all generated files
Remove-Item 01-mock-data.json, 01-order.json, 01-report.md, 02-report.md
```

### Backup

```powershell
# Backup custom mock data
Copy-Item 01-mock-data.json 01-mock-data.backup.json
```

### Version Control

**Commit:**

- `README.md`
- `01-Generate-SP-TestData.ps1`
- `02-Test-StoredProcedures.ps1`
- `01-mock-data.json` (if customized)

**Ignore:**

- `01-order.json` (auto-generated)
- `01-report.md` (auto-generated)
- `02-report.md` (auto-generated)

---

## Support

For issues or questions:

1. Check `02-report.md` recommendations section
2. Review error categories above
3. Verify database schema matches SP expectations
4. Ensure MAMP MySQL is running
5. Check PowerShell version: `pwsh --version` (must be 7.0+)

**Last Updated:** January 11, 2026  
**PowerShell Version Required:** 7.0+  
**Database:** MySQL 8.x (MAMP)  
**Total SPs Tested:** 153
