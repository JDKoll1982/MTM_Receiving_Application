<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="MTM_Receiving_Application.Module_Volvo.Views.View_Volvo_ShipmentEntry"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:mi="using:Material.Icons.WinUI3"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:views="using:MTM_Receiving_Application.Module_Volvo.Views"
    xmlns:models="using:MTM_Receiving_Application.Module_Volvo.Models"
    xmlns:converters="using:MTM_Receiving_Application.Module_Core.Converters"
    mc:Ignorable="d"
    Loaded="OnLoaded">

    <Page.Resources>
        <converters:Converter_BooleanToVisibility x:Key="BooleanToVisibilityConverter"/>
        <converters:NullableDoubleToDoubleConverter x:Key="NullableDoubleToDoubleConverter"/>
        <converters:Converter_BoolToString x:Key="BoolToStringConverter"/>
        <converters:Converter_IntToString x:Key="IntToStringConverter"/>
        <converters:Converter_InverseBool x:Key="InverseBoolConverter"/>
        <converters:Converter_NullableDoubleToString x:Key="NullableDoubleToStringConverter"/>
        <converters:Converter_NullableIntToString x:Key="NullableIntToStringConverter"/>
    </Page.Resources>

    <Grid Padding="24" RowSpacing="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Success Message -->
        <InfoBar Grid.Row="0"
                 IsOpen="{x:Bind ViewModel.IsSuccessMessageVisible, Mode=OneWay}"
                 Severity="Success"
                 Message="{x:Bind ViewModel.SuccessMessage, Mode=OneWay}"
                 IsClosable="True"/>

        <!-- Header Section -->
        <StackPanel Grid.Row="1" Spacing="16">
            <!-- Shipment Info Row -->
            <Grid ColumnSpacing="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <CalendarDatePicker Grid.Column="0"
                                    Header="Shipment Date"
                                    Date="{x:Bind ViewModel.ShipmentDate, Mode=TwoWay}"
                                    HorizontalAlignment="Stretch"/>

                <NumberBox Grid.Column="1"
                           Header="Shipment Number"
                           Value="{x:Bind ViewModel.ShipmentNumber, Mode=TwoWay}"
                           Minimum="1"
                           SpinButtonPlacementMode="Hidden"
                           HorizontalAlignment="Stretch"/>

                <Button Grid.Column="2"
                        VerticalAlignment="Bottom"
                        Style="{StaticResource AccentButtonStyle}"
                        Click="AddPartButton_Click"
                        Margin="0,0,0,4"
                        MinWidth="120">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <SymbolIcon Symbol="Add"/>
                        <TextBlock Text="Add Part"/>
                    </StackPanel>
                </Button>
            </Grid>
        </StackPanel>

        <!-- Parts Entry DataGrid -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <TextBlock Grid.Row="0" 
                       Text="Parts Received" 
                       Style="{StaticResource SubtitleTextBlockStyle}"
                       Margin="0,0,0,8"/>

            <controls:DataGrid x:Name="ShipmentLinesGrid" Grid.Row="1"
                               ItemsSource="{x:Bind ViewModel.Parts, Mode=OneWay}"
                               SelectedItem="{x:Bind ViewModel.SelectedPart, Mode=TwoWay}"
                               AutoGenerateColumns="False"
                               CanUserSortColumns="False"
                               CanUserReorderColumns="False"
                               GridLinesVisibility="All">
                <controls:DataGrid.Columns>
                    <controls:DataGridTemplateColumn Header="Part Number" Width="2*">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="models:Model_VolvoShipmentLine">
                                <TextBlock Text="{x:Bind PartNumber, Mode=OneWay}" 
                                           VerticalAlignment="Center"
                                           Margin="8,0"/>
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>

                    <controls:DataGridTemplateColumn Header="Received Skids"
                                                      Width="*">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="models:Model_VolvoShipmentLine">
                                <TextBox Text="{x:Bind ReceivedSkidCount, Mode=TwoWay, Converter={StaticResource IntToStringConverter}}"
                                         InputScope="Number"
                                         HorizontalAlignment="Stretch"
                                         VerticalAlignment="Stretch"
                                         BorderThickness="0"
                                         Background="Transparent"/>
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>

                    <controls:DataGridTemplateColumn Header="Calculated Pieces" Width="*">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="models:Model_VolvoShipmentLine">
                                <TextBlock Text="{x:Bind CalculatedPieceCount, Mode=OneWay}" 
                                           VerticalAlignment="Center"
                                           Margin="8,0"/>
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>

                    <controls:DataGridTemplateColumn Header="Discrepancy" Width="230">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="models:Model_VolvoShipmentLine">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <Button Content="Report"
                                            Click="ReportDiscrepancyButton_Click"
                                            IsEnabled="{x:Bind HasDiscrepancy, Mode=OneWay, Converter={StaticResource InverseBoolConverter}}"
                                            Tag="{x:Bind}"
                                            MinWidth="50"/>
                                    <Button Content="View"
                                            Click="ViewDiscrepancyButton_Click"
                                            IsEnabled="{x:Bind HasDiscrepancy, Mode=OneWay}"
                                            Tag="{x:Bind}"
                                            MinWidth="50"/>
                                    <Button Content="Remove"
                                            Click="RemoveDiscrepancyButton_Click"
                                            IsEnabled="{x:Bind HasDiscrepancy, Mode=OneWay}"
                                            Tag="{x:Bind}"
                                            MinWidth="50"/>
                                </StackPanel>
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>

                    <controls:DataGridTemplateColumn Header="Expected Skids"
                                                      Width="0"
                                                      Visibility="Collapsed">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="models:Model_VolvoShipmentLine">
                                <TextBlock Text="{x:Bind ExpectedSkidCount, Mode=OneWay, Converter={StaticResource NullableDoubleToStringConverter}}" />
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>

                    <controls:DataGridTemplateColumn Header="Expected Pieces" 
                                                      Width="0"
                                                      Visibility="Collapsed">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="models:Model_VolvoShipmentLine">
                                <TextBlock Text="{x:Bind ExpectedPieceCount, Mode=OneWay, Converter={StaticResource NullableIntToStringConverter}}" />
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>

                    <controls:DataGridTemplateColumn Header="Difference" 
                                                      Width="0"
                                                      Visibility="Collapsed">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="models:Model_VolvoShipmentLine">
                                <TextBlock Text="{x:Bind PieceDifference, Mode=OneWay, Converter={StaticResource NullableIntToStringConverter}}" />
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>

                    <controls:DataGridTemplateColumn Header="Discrepancy Note"
                                                      Width="0"
                                                      Visibility="Collapsed">
                        <controls:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="models:Model_VolvoShipmentLine">
                                <TextBlock Text="{x:Bind DiscrepancyNote, Mode=OneWay, TargetNullValue=''}" />
                            </DataTemplate>
                        </controls:DataGridTemplateColumn.CellTemplate>
                    </controls:DataGridTemplateColumn>
                </controls:DataGrid.Columns>
            </controls:DataGrid>

            <!-- Order Notes Section -->
            <TextBox Grid.Row="2"
                     Header="Order Notes (applies to entire shipment)"
                     Text="{x:Bind ViewModel.Notes, Mode=TwoWay}"
                     PlaceholderText="Enter any additional notes for this shipment..."
                     TextWrapping="Wrap"
                     AcceptsReturn="True"
                     MinHeight="60"
                     MaxHeight="120"
                     Margin="0,12,0,0"/>
        </Grid>

        <!-- Action Buttons -->
        <CommandBar Grid.Row="3" DefaultLabelPosition="Right">
            <AppBarButton Icon="Delete" Label="Remove Selected Part" Click="RemoveSelectedPartButton_Click"/>
            <AppBarSeparator/>
            <AppBarButton Label="Generate Labels" Command="{x:Bind ViewModel.GenerateLabelsCommand}">
                <AppBarButton.Icon>
                    <FontIcon Glyph="&#xE8B7;"/>
                </AppBarButton.Icon>
            </AppBarButton>
            <AppBarButton Icon="Mail" Label="Preview Email" Command="{x:Bind ViewModel.PreviewEmailCommand}"/>
            <AppBarSeparator/>
            <AppBarButton Icon="Save" Label="Save as Pending" Command="{x:Bind ViewModel.SaveAsPendingCommand}"/>
            <AppBarButton Icon="Accept" 
                          Label="Complete Shipment" 
                          Command="{x:Bind ViewModel.CompleteShipmentCommand}"
                          Visibility="{x:Bind ViewModel.HasPendingShipment, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            <AppBarSeparator/>
            <AppBarButton Icon="Calendar" Label="View History" Command="{x:Bind ViewModel.ViewHistoryCommand}"/>
        </CommandBar>

        <!-- Status Bar -->
        <Grid Grid.Row="3" Margin="0,8,0,0" Visibility="Collapsed">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <ProgressRing IsActive="{x:Bind ViewModel.IsBusy, Mode=OneWay}" 
                              Width="20" 
                              Height="20"
                              Visibility="{x:Bind ViewModel.IsBusy, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" 
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
