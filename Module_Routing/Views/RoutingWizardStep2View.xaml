<Page
    x:Class="MTM_Receiving_Application.Module_Routing.Views.RoutingWizardStep2View"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:MTM_Receiving_Application.Module_Routing.ViewModels"
    xmlns:models="using:MTM_Receiving_Application.Module_Routing.Models"
    xmlns:coreConverters="using:MTM_Receiving_Application.Module_Core.Converters"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}"
    Loaded="OnPageLoaded">

    <Page.Resources>
        <coreConverters:Converter_IntToVisibility x:Key="IntToVisibilityConverter"/>
    </Page.Resources>

    <Grid Padding="24" RowSpacing="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <TextBlock Grid.Row="0" 
                   Text="Step 2: Recipient Selection" 
                   Style="{StaticResource TitleTextBlockStyle}"/>

        <!-- Quick Add Buttons -->
        <StackPanel Grid.Row="1" Spacing="12">
            <TextBlock Text="Quick Add (Most Used)" 
                       Style="{StaticResource SubtitleTextBlockStyle}"/>

            <Grid ColumnSpacing="8">
                <!-- Replaced hardcoded buttons with ItemsControl to prevent IndexOutOfRange -->
                <ItemsControl ItemsSource="{x:Bind ViewModel.QuickAddRecipients, Mode=OneWay}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="8"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="models:Model_RoutingRecipient">
                            <Button Content="{x:Bind Name}"
                                    Command="{Binding ElementName=RootPage, Path=ViewModel.QuickAddRecipientCommand}"
                                    CommandParameter="{x:Bind}"
                                    Width="160"
                                    HorizontalAlignment="Stretch"
                                    Style="{StaticResource AccentButtonStyle}"/>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </StackPanel>

        <!-- Search Box -->
        <TextBox Grid.Row="2"
                 Header="Search Recipients"
                 PlaceholderText="Search by name, location, or department"
                 Text="{x:Bind ViewModel.SearchText, Mode=TwoWay}"/>

        <!-- Recipients List -->
        <Border Grid.Row="3" 
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="4">
            <ListView ItemsSource="{x:Bind ViewModel.FilteredRecipients, Mode=OneWay}"
                      SelectedItem="{x:Bind ViewModel.SelectedRecipient, Mode=TwoWay}"
                      SelectionMode="Single">
                <ListView.HeaderTemplate>
                    <DataTemplate>
                        <Grid Padding="8" ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="Name" FontWeight="SemiBold"/>
                            <TextBlock Grid.Column="1" Text="Location" FontWeight="SemiBold"/>
                            <TextBlock Grid.Column="2" Text="Department" FontWeight="SemiBold"/>
                        </Grid>
                    </DataTemplate>
                </ListView.HeaderTemplate>
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:Model_RoutingRecipient">
                        <Grid Padding="8" ColumnSpacing="12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{x:Bind Name}"/>
                            <TextBlock Grid.Column="1" Text="{x:Bind Location}"/>
                            <TextBlock Grid.Column="2" Text="{x:Bind Department}"/>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Border>

        <!-- Status Bar -->
        <StackPanel Grid.Row="4" Orientation="Horizontal" Spacing="12">
            <ProgressRing IsActive="{x:Bind ViewModel.IsBusy, Mode=OneWay}"
                          Width="20" Height="20"/>
            <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}"
                       VerticalAlignment="Center"/>
        </StackPanel>

        <!-- Action Buttons -->
        <StackPanel Grid.Row="5" Orientation="Horizontal" Spacing="12" HorizontalAlignment="Right">
            <Button Content="Back"
                    Command="{x:Bind ViewModel.NavigateBackToStep1Command}"/>
            <Button Content="Next: Review"
                    Command="{x:Bind ViewModel.ProceedToStep3Command}"
                    Style="{StaticResource AccentButtonStyle}"/>
        </StackPanel>
    </Grid>
</Page>
