<UserControl
    x:Class="MTM_Receiving_Application.Module_Receiving.Views.View_Receiving_ManualEntry"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls"
    xmlns:viewmodels="using:MTM_Receiving_Application.Module_Receiving.ViewModels"
    xmlns:enums="using:MTM_Receiving_Application.Module_Core.Models.Enums"
    xmlns:converters="using:MTM_Receiving_Application.Module_Core.Converters"
    mc:Ignorable="d"
    x:Name="Root">

    <UserControl.Resources>
        <converters:Converter_DecimalToString x:Key="DecimalToStringConverter"/>
        <converters:Converter_PartIDToQualityHoldBrush x:Key="PartIDToQualityHoldBrushConverter"/>
        <converters:Converter_PartIDToQualityHoldTextColor x:Key="PartIDToQualityHoldTextColorConverter"/>
    </UserControl.Resources>

    <Grid Padding="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Grid Grid.Row="0" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                <Button x:Name="AddRowButton" Command="{x:Bind ViewModel.AddRowCommand}" Style="{StaticResource AccentButtonStyle}" ToolTipService.ToolTip="{x:Bind ViewModel.GetTooltip('Button.AddRow'), Mode=OneWay}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE710;"/>
                        <TextBlock Text="{x:Bind ViewModel.ManualEntryAddRowText, Mode=OneWay}"/>
                    </StackPanel>
                </Button>
                <Button Command="{x:Bind ViewModel.AddMultipleRowsCommand}" ToolTipService.ToolTip="{x:Bind ViewModel.GetTooltip('Button.AddMultipleRows'), Mode=OneWay}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE710;"/>
                        <TextBlock Text="{x:Bind ViewModel.ManualEntryAddMultipleText, Mode=OneWay}"/>
                    </StackPanel>
                </Button>
                <Button Command="{x:Bind ViewModel.RemoveRowCommand}" ToolTipService.ToolTip="{x:Bind ViewModel.GetTooltip('Button.RemoveRow'), Mode=OneWay}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE74D;"/>
                        <TextBlock Text="{x:Bind ViewModel.ManualEntryRemoveRowText, Mode=OneWay}"/>
                    </StackPanel>
                </Button>
                <Button Command="{x:Bind ViewModel.AutoFillCommand}" ToolTipService.ToolTip="{x:Bind ViewModel.GetTooltip('Button.AutoFill'), Mode=OneWay}">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE74E;"/>
                        <TextBlock Text="{x:Bind ViewModel.ManualEntryAutoFillText, Mode=OneWay}"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Data Grid -->
        <controls:DataGrid Grid.Row="1"
                          x:Name="ManualEntryDataGrid"
                          ItemsSource="{x:Bind ViewModel.Loads, Mode=OneWay}"
                          SelectedItem="{x:Bind ViewModel.SelectedLoad, Mode=TwoWay}"
                          AutoGenerateColumns="False"
                          IsReadOnly="False"
                          CanUserSortColumns="True"
                          GridLinesVisibility="All"
                          HeadersVisibility="Column"
                          SelectionMode="Single"
                          KeyDown="ManualEntryDataGrid_KeyDown"
                          CurrentCellChanged="ManualEntryDataGrid_CurrentCellChanged"
                          Tapped="ManualEntryDataGrid_Tapped"
                          LoadingRow="ManualEntryDataGrid_LoadingRow">
            <controls:DataGrid.Columns>
                <controls:DataGridTextColumn Header="{x:Bind ViewModel.ManualEntryColumnLoadNumberText, Mode=OneWay}" Binding="{Binding LoadNumber}" IsReadOnly="True"/>
                
                <!-- PO Number column with auto-formatting -->
                <controls:DataGridTemplateColumn Header="{x:Bind ViewModel.ManualEntryColumnPoNumberText, Mode=OneWay}" Width="*">
                    <controls:DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock 
                                Text="{Binding PoNumber}" 
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"/>
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellTemplate>
                    <controls:DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox 
                                Text="{Binding PoNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                BorderThickness="0"
                                LostFocus="PONumberTextBox_LostFocus"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                VerticalContentAlignment="Center"/>
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellEditingTemplate>
                </controls:DataGridTemplateColumn>
                
                <!-- Part ID column with conditional text color for quality hold -->
                <controls:DataGridTemplateColumn Header="{x:Bind ViewModel.ManualEntryColumnPartIdText, Mode=OneWay}" Width="*">
                    <controls:DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock 
                                Text="{Binding PartID}" 
                                Foreground="{Binding PartID, Converter={StaticResource PartIDToQualityHoldTextColorConverter}}"                                
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"/>
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellTemplate>
                    <controls:DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox 
                                Text="{Binding PartID, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                BorderThickness="0"
                                LostFocus="PartIDTextBox_LostFocus"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                VerticalContentAlignment="Center"/>
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellEditingTemplate>
                </controls:DataGridTemplateColumn>
                
                <!-- Weight/Quantity column -->
                <controls:DataGridTemplateColumn Header="{x:Bind ViewModel.ManualEntryColumnWeightQtyText, Mode=OneWay}" Width="*">
                    <controls:DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock 
                                Text="{Binding WeightQuantity, Converter={StaticResource DecimalToStringConverter}}"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"
                                />
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellTemplate>
                    <controls:DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox 
                                Text="{Binding WeightQuantity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource DecimalToStringConverter}}"
                                BorderThickness="0"
                                
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                HorizontalContentAlignment="Stretch"
                                VerticalContentAlignment="Center"/>
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellEditingTemplate>
                </controls:DataGridTemplateColumn>
                
                <!-- Heat/Lot Number column -->
                <controls:DataGridTemplateColumn Header="{x:Bind ViewModel.ManualEntryColumnHeatLotText, Mode=OneWay}" Width="*">
                    <controls:DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock 
                                Text="{Binding HeatLotNumber}"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"
                                />
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellTemplate>
                    <controls:DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox 
                                Text="{Binding HeatLotNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                BorderThickness="0"
                                
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                HorizontalContentAlignment="Stretch"
                                VerticalContentAlignment="Center"/>
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellEditingTemplate>
                </controls:DataGridTemplateColumn>

                <!-- Package Type column -->
                
                <controls:DataGridTextColumn Header="{x:Bind ViewModel.ManualEntryColumnPkgTypeText, Mode=OneWay}" Binding="{Binding PackageType}" IsReadOnly="True"/>
                
                <!-- Packages Per Load column -->
                <controls:DataGridTemplateColumn Header="{x:Bind ViewModel.ManualEntryColumnPkgsPerLoadText, Mode=OneWay}" Width="*">
                    <controls:DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock 
                                Text="{Binding PackagesPerLoad}"
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Center"
                                />
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellTemplate>
                    <controls:DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox 
                                Text="{Binding PackagesPerLoad, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                BorderThickness="0"
                                
                                HorizontalAlignment="Stretch"
                                VerticalAlignment="Stretch"
                                HorizontalContentAlignment="Stretch"
                                VerticalContentAlignment="Center"/>
                        </DataTemplate>
                    </controls:DataGridTemplateColumn.CellEditingTemplate>
                </controls:DataGridTemplateColumn>

                <!-- Weight Per Package column -->
                <controls:DataGridTextColumn Header="{x:Bind ViewModel.ManualEntryColumnWtPerPkgText, Mode=OneWay}" Binding="{Binding WeightPerPackage, Converter={StaticResource DecimalToStringConverter}}" IsReadOnly="True"/>

</controls:DataGrid.Columns>
        </controls:DataGrid>

        <!-- Navigation -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0" Spacing="12">
            <Button Content="{x:Bind ViewModel.ManualEntrySaveAndFinishText, Mode=OneWay}" 
                    Command="{x:Bind ViewModel.SaveCommand}" 
                    Style="{StaticResource AccentButtonStyle}" 
                    ToolTipService.ToolTip="{x:Bind ViewModel.GetTooltip('Button.SaveAndFinish'), Mode=OneWay}"/>
        </StackPanel>
    </Grid>
</UserControl>

