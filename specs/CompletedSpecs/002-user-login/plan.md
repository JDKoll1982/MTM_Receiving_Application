# Implementation Plan: User Authentication & Login System

**Branch**: `002-user-login` | **Date**: December 15, 2025 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-user-login/spec.md`

**Note**: This implementation plan was generated by the `/speckit.plan` command following complete specification clarification.

## Summary

Implement multi-tier authentication system integrating with the application's startup splash screen sequence. The system automatically detects workstation type (personal vs. shared terminal) and applies appropriate authentication: Windows username auto-login for personal workstations, or PIN-based login for shared shop floor terminals. Includes automatic new user creation workflow when Windows usernames are not found in the MySQL database, session timeout management (30 min personal, 15 min shared), and optional Visual/Infor ERP credential storage for authorized users.

**Technical Approach**: Authentication occurs during startup Phase 2 (steps 40-60%) with WinUI 3 ContentDialog-based user interfaces displayed over the splash screen. Database-driven configuration stores shared terminal names and department lists for flexibility. Plain text storage for PINs (4 digits, shop floor physical security adequate) and ERP credentials (masked in UI). Session management tracks inactivity via UI input events, automatically closing application on timeout.

## Technical Context

**Language/Version**: C# 12 / .NET 8.0  
**Primary Dependencies**: WinUI 3 (Windows App SDK 1.5+), Microsoft.Extensions.DependencyInjection, MySql.Data (or Dapper for MySQL)  
**Storage**: MySQL 8.0+ database (new `users`, `workstation_config`, `departments` tables)  
**Testing**: xUnit or MSTest for unit/integration tests, manual testing scenarios documented in spec  
**Target Platform**: Windows 10 19041+ (desktop application, x64 and ARM64)  
**Project Type**: Desktop WinUI 3 MVVM application (single project with MVVM structure)  
**Performance Goals**: 
- Splash screen display < 500ms from launch
- Authentication phase (steps 40-60%) < 3 seconds for automatic Windows login
- Database queries < 800ms per operation
- Dialog display < 200ms from trigger
- Total startup < 10 seconds (all authentication scenarios)  
**Constraints**: 
- UI thread never blocked > 100ms (all database operations async)
- Splash screen progress updates every 200-500ms
- Session timeout: 30 min (personal workstations), 15 min (shared terminals)
- Maximum 3 login attempts on shared terminals before application closes  
**Scale/Scope**: 
- ~50-100 concurrent users across multiple workstations
- Single-site manufacturing operation
- 3 database tables, 6 stored procedures
- 4 new Views/Dialogs (SplashScreen, SharedTerminalLogin, NewUserSetup, plus MainWindow header updates)
- 5 new ViewModels, 3 new Models, 2 new Services

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ✅ **PASS** - Constitution file is template only, no specific gates defined yet for this project.

**Notes**: 
- Project follows existing MVVM architecture established in Phase 1 Infrastructure
- Authentication is foundational feature with no dependencies on other features
- Database schema is new (greenfield), designed optimally for this feature's needs
- No architectural conflicts or complexity violations identified
- When constitution is defined, will re-evaluate compliance

**Re-check After Phase 1**: Will verify data model and contracts comply with any constitution rules established by then.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
MTM_Receiving_Application/ (root)
├── Database/
│   ├── Schemas/
│   │   └── 02_create_authentication_tables.sql      # New: users, workstation_config, departments tables
│   └── StoredProcedures/
│       └── Authentication/                           # New folder
│           ├── sp_GetUserByWindowsUsername.sql
│           ├── sp_ValidateUserPin.sql
│           ├── sp_CreateNewUser.sql
│           ├── sp_LogUserActivity.sql
│           ├── sp_GetSharedTerminalNames.sql
│           └── sp_GetDepartments.sql
│
├── Models/
│   ├── Model_User.cs                                 # New: User/Employee data structure
│   ├── Model_UserSession.cs                          # New: Active session management
│   └── Model_WorkstationConfig.cs                    # New: Workstation detection logic
│
├── ViewModels/
│   └── Shared/
│       ├── SplashScreenViewModel.cs                  # New: Splash screen with progress reporting
│       ├── SharedTerminalLoginViewModel.cs           # New: PIN login dialog VM
│       ├── NewUserSetupViewModel.cs                  # New: New user creation dialog VM
│       └── MainWindowViewModel.cs                    # Update: Add user display header
│
├── Views/
│   └── Shared/
│       ├── SplashScreenWindow.xaml(.cs)              # New: Splash screen window
│       ├── SharedTerminalLoginDialog.xaml(.cs)       # New: PIN login ContentDialog
│       ├── NewUserSetupDialog.xaml(.cs)              # New: User creation ContentDialog
│       └── MainWindow.xaml(.cs)                      # Update: Add user info header
│
├── Services/
│   ├── Authentication/                               # New folder
│   │   ├── IService_Authentication.cs                # New: Authentication service interface
│   │   ├── Service_Authentication.cs                 # New: Implementation
│   │   ├── IService_SessionManager.cs                # New: Session management interface
│   │   └── Service_SessionManager.cs                 # New: Session timeout tracking
│   └── Startup/
│       └── Service_OnStartup_AppLifecycle.cs         # Update: Integrate authentication at steps 40-60%
│
├── Data/
│   └── Authentication/                               # New folder
│       └── Dao_User.cs                               # New: User database access (CRUD, validation)
│
├── Contracts/
│   └── Services/
│       ├── IService_Authentication.cs                # New: Service contract
│       └── IService_SessionManager.cs                # New: Session contract
│
├── Tests/
│   ├── Unit/
│   │   ├── AuthenticationServiceTests.cs             # New: Unit tests for auth logic
│   │   ├── SessionManagerTests.cs                    # New: Session timeout tests
│   │   └── UserDaoTests.cs                           # New: Database access tests
│   └── Integration/
│       ├── WindowsAuthenticationFlowTests.cs         # New: End-to-end personal workstation
│       ├── PinAuthenticationFlowTests.cs             # New: End-to-end shared terminal
│       └── NewUserCreationFlowTests.cs               # New: End-to-end user creation
│
└── App.xaml.cs                                        # Update: Register auth services in DI container
```

**Structure Decision**: Single WinUI 3 Desktop MVVM project following existing Phase 1 Infrastructure patterns. Authentication components organized under new `Authentication/` folders within established directories (`Services/`, `Data/`, `Views/Shared/`, `ViewModels/Shared/`). Database scripts follow existing convention (`Database/Schemas/` and `Database/StoredProcedures/`). This maintains consistency with the established codebase structure while clearly isolating new authentication-related code.

## Complexity Tracking

**Status**: No complexity violations to track. Constitution is template-only with no defined rules yet.

**Design Decisions Made for Simplicity**:
- Plain text PIN/ERP credential storage (simpler than encryption, adequate for physical security environment)
- No logout button (close app to end session - simpler UX and implementation)
- Session timeout closes app completely (simpler than re-authentication dialogs)
- Department dropdown with "Other" option (simpler than full admin UI for department management)
- Any user interaction resets timeout (standard pattern, simpler than tracking specific operations)

**Future Considerations**: 
- If constitution adopts "Test-First" principle: Will need TDD workflow for Phase 2 implementation
- If constitution requires observability: Already have `sp_LogUserActivity` for audit trail
- If constitution requires versioning: Database schema includes version tracking capability

- Any user interaction resets timeout (standard pattern, simpler than tracking specific operations)

**Future Considerations**: 
- If constitution adopts "Test-First" principle: Will need TDD workflow for Phase 2 implementation
- If constitution requires observability: Already have `sp_LogUserActivity` for audit trail
- If constitution requires versioning: Database schema includes version tracking capability

---

## Phase 0: Outline & Research

**Status**:  Complete

All technical unknowns were resolved during the specification clarification phase. See [research.md](./research.md) for complete details including:

- Technology stack decisions (C# 12, .NET 8.0, WinUI 3, MySQL 8.0+)
- Design decisions with rationale (PIN storage, session management, department configuration, etc.)
- Best practices for WinUI 3 ContentDialog, async database operations, session management
- Integration points with existing Phase 1 Infrastructure
- No blocking unknowns remain

**Key Decisions**:
1. Plain text PIN storage (4 digits, adequate physical security)
2. No logout button (close app to end session)
3. Database configuration tables for flexibility (workstation_config, departments)
4. Session timeout closes app completely (simpler than re-authentication)
5. Allow concurrent sessions across workstation types

**Output**: [research.md](./research.md) - 15 decisions documented, technology stack confirmed

---

## Phase 1: Design & Contracts

**Status**:  Complete

### Data Model

Complete entity design with 4 database tables:
- `users` (employee authentication and profile data)
- `workstation_config` (workstation type detection)
- `departments` (department dropdown configuration)
- `user_activity_log` (audit trail)

Application models:
- `Model_User` (user/employee entity)
- `Model_UserSession` (active session management)
- `Model_WorkstationConfig` (workstation detection)

**Output**: [data-model.md](./data-model.md) - Complete ERD, table schemas, validation rules, state transitions

### API Contracts

Two service interfaces designed:
1. **IService_Authentication**: User authentication, validation, workstation detection, activity logging
2. **IService_SessionManager**: Session lifecycle, timeout monitoring, activity tracking

**Output**: [contracts/](./contracts/) directory with:
- [IService_Authentication.md](./contracts/IService_Authentication.md) - 7 methods specified
- [IService_SessionManager.md](./contracts/IService_SessionManager.md) - 6 methods + 1 event specified

### Quickstart Guide

10-phase implementation plan with detailed steps, time estimates, and success criteria.

**Output**: [quickstart.md](./quickstart.md) - Complete development roadmap (12-14 days estimated)

### Agent Context Update

Technology stack and architecture details will be added to AI agent context for future assistance.

**Command**: `.specify/scripts/powershell/update-agent-context.ps1 -AgentType copilot`

---

## Phase 2: Task Breakdown

**Status**: Not started - Use `/speckit.tasks` command

The next step is to generate the detailed task breakdown from the quickstart guide using the `/speckit.tasks` command. This will create `tasks.md` with:

- Granular task checklist
- Dependencies between tasks
- Acceptance criteria for each task
- Testing requirements
- Definition of Done for the feature

**Command**: `/speckit.tasks` (to be run after plan approval)

---

## Implementation Summary

### Phases Overview

| Phase | Name | Status | Output | Time Estimate |
|-------|------|--------|--------|---------------|
| 0 | Research & Decisions |  Complete | [research.md](./research.md) | N/A (during spec) |
| 1 | Design & Contracts |  Complete | [data-model.md](./data-model.md), [contracts/](./contracts/), [quickstart.md](./quickstart.md) | N/A (during plan) |
| 2 | Task Breakdown |  Pending | [tasks.md](./tasks.md) | Use `/speckit.tasks` |
| 3-12 | Implementation |  Pending | Source code | 12-14 days (80-96 hours) |

### Key Deliverables

**Documentation** ( Complete):
- Feature specification with 15 clarification decisions
- Research document with technology decisions
- Complete data model with ERD and schemas
- Service contracts with method specifications
- 10-phase quickstart implementation guide

**Code** ( To Be Implemented):
- 4 database tables + 6 stored procedures
- 3 Models, 2 Services, 1 DAO, 3 Views, 4 ViewModels
- Integration with startup sequence and splash screen
- Unit and integration tests

### Next Actions

1.  Review and approve this plan
2.  Run agent context update: `.specify/scripts/powershell/update-agent-context.ps1 -AgentType copilot`
3.  Generate task breakdown: `/speckit.tasks`
4.  Begin Phase 1 implementation: Database Foundation
5.  Follow quickstart.md phases sequentially

---

## Plan Completion Checklist

- [x] Summary written with technical approach
- [x] Technical Context filled with all required details
- [x] Constitution Check performed (PASS - template only)
- [x] Project Structure documented with actual paths
- [x] Complexity Tracking addressed (no violations)
- [x] Phase 0 completed (research.md generated)
- [x] Phase 1 completed (data-model.md, contracts/, quickstart.md generated)
- [x] All unknowns from Technical Context resolved
- [x] All NEEDS CLARIFICATION items addressed
- [x] Implementation plan is actionable and complete

**Status**:  **PLAN COMPLETE** - Ready for agent context update and task generation

---

**Generated**: December 15, 2025  
**Command**: `/speckit.plan`  
**Next Command**: `.specify/scripts/powershell/update-agent-context.ps1 -AgentType copilot` then `/speckit.tasks`
